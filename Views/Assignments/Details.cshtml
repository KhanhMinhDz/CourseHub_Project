@model CourseManagement.Models.Assignment

@{
    ViewData["Title"] = Model.Title;
    var cls = ViewBag.Class as CourseManagement.Models.ClassRoom;
    var currentUserId = User?.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
    var isInstructor = User?.IsInRole("Instructor") ?? false;
    var isAdmin = User?.IsInRole("Admin") ?? false;
    var canEdit = isAdmin || (cls != null && cls.InstructorId == currentUserId);

    // Ki·ªÉm tra xem h·ªçc vi√™n ƒë√£ n·ªôp b√†i ch∆∞a
    var db = Context.RequestServices.GetService(typeof(CourseManagement.Data.ApplicationDbContext))
    as CourseManagement.Data.ApplicationDbContext;
    var hasSubmitted = db?.Submissions.Any(s => s.AssignmentId == Model.Id && s.StudentId == currentUserId) ?? false;
}

<h1>@Model.Title</h1>
<p class="text-muted">L·ªõp: @cls?.Title</p>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle"></i> @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle"></i> @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle"></i> @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@* Hi·ªÉn th·ªã tr·∫°ng th√°i n·ªôp b√†i cho h·ªçc vi√™n *@
@if (!canEdit && currentUserId != null && hasSubmitted)
{
    <div class="alert alert-success mb-3">
        <i class="bi bi-check-circle-fill"></i> B·∫°n ƒë√£ n·ªôp b√†i t·∫≠p n√†y.
        <a asp-controller="Submissions" asp-action="Index" asp-route-assignmentId="@Model.Id"
            class="btn btn-sm btn-outline-success ms-2">
            Xem b√†i n·ªôp
        </a>
    </div>
}

<ul class="nav nav-tabs" id="assignmentTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="edit-tab" data-bs-toggle="tab" data-bs-target="#edit" type="button"
            role="tab">Ch·ªânh s·ª≠a</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="subs-tab" data-bs-toggle="tab" data-bs-target="#subs" type="button" role="tab">N·ªôp
            b√†i</button>
    </li>
</ul>
<div class="tab-content p-3 border border-top-0">
    <div class="tab-pane fade show active" id="edit" role="tabpanel">
        @if (!canEdit)
        {
            <div class="alert alert-info">B·∫°n kh√¥ng c√≥ quy·ªÅn ch·ªânh s·ª≠a b√†i t·∫≠p n√†y.</div>
        }
        else
        {
            <form asp-action="EditDescription" method="post" id="editAssignmentForm">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@Model.Id" />
                
                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label class="form-label">Ti√™u ƒë·ªÅ</label>
                            <input name="title" class="form-control" value="@Model.Title" required />
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">H·∫°n n·ªôp b√†i (Deadline)</label>
                            <input type="datetime-local" name="dueDate" class="form-control" 
                                   value="@(Model.DueDate?.ToLocalTime().ToString("yyyy-MM-ddTHH:mm"))" />
                            <small class="text-muted">ƒê·ªÉ tr·ªëng = kh√¥ng gi·ªõi h·∫°n th·ªùi gian</small>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">N·ªôi dung / ƒê·ªÅ b√†i</label>
                    <textarea id="descriptionEditor" name="description" class="form-control" rows="8">@Model.Description</textarea>
                </div>
                
                <button class="btn btn-primary" type="submit">
                    <i class="bi bi-save"></i> L∆∞u thay ƒë·ªïi
                </button>
            </form>
            <hr />
            <h4>üìÇ T·∫£i l√™n file c√¢u h·ªèi (CSV ho·∫∑c Excel)</h4>

            <form asp-action="UploadQuestions" asp-controller="Assignments" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                <input type="hidden" name="assignmentId" value="@Model.Id" />

                <div class="mb-3">
                    <label for="file" class="form-label">Ch·ªçn file:</label>
                    <input type="file" name="file" class="form-control" required />
                </div>

                <button type="submit" class="btn btn-success">T·∫£i l√™n</button>
            </form>

            @if (TempData["Error"] != null)
            {
                <div class="alert alert-danger mt-3">@TempData["Error"]</div>
            }
            @if (TempData["Success"] != null)
            {
                <div class="alert alert-success mt-3">@TempData["Success"]</div>
            }
        }
        @{
            var questions = new List<CourseManagement.Models.Question>();

            if (db != null)
            {
                var tmp = db.Questions
                .Where(q => q.AssignmentId == Model.Id)
                .ToList();

                if (tmp != null)
                    questions = tmp;
            }
        }

    </div>
    <div class="tab-pane fade" id="subs" role="tabpanel">
        <h4>Danh s√°ch sinh vi√™n v√† tr·∫°ng th√°i n·ªôp</h4>

        @if (canEdit)
        {
            <a asp-action="DownloadAllSubmissions" asp-route-id="@Model.Id" class="btn btn-secondary mb-2">T·∫£i t·∫•t c·∫£ b√†i
                n·ªôp (.zip)</a>
        }
        <table class="table">
            <thead>
                <tr>
                    <th>H·ªç t√™n</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>T·ªáp n·ªôp</th>
                </tr>
            </thead>
            <tbody>
                @{
                    var enrollments = Context.RequestServices.GetService(typeof(CourseManagement.Data.ApplicationDbContext))
                    as CourseManagement.Data.ApplicationDbContext;
                    var userMgr =
                    Context.RequestServices.GetService(typeof(Microsoft.AspNetCore.Identity.UserManager<CourseManagement.Data.ApplicationUser>))
                    as Microsoft.AspNetCore.Identity.UserManager<CourseManagement.Data.ApplicationUser>;
                    var list = enrollments?.Enrollments.Where(e => e.ClassRoomId == Model.ClassRoomId).ToList() ?? new
                    List<CourseManagement.Models.Enrollment>();
                    foreach (var e in list)
                    {
                        var user = userMgr?.FindByIdAsync(e.StudentId).GetAwaiter().GetResult();
                        var sub = enrollments?.Submissions.FirstOrDefault(s => s.AssignmentId == Model.Id && s.StudentId ==
                        e.StudentId);
                        var submitted = sub != null;
                        <tr class="@(submitted ? "table-success" : "table-danger")">
                            <td>@(user?.FullName ?? user?.UserName)</td>
                            <td>@(submitted ? "ƒê√£ n·ªôp" : "Ch∆∞a n·ªôp")</td>
                            <td>
                                @if (submitted && !string.IsNullOrEmpty(sub?.FilePath))
                                {
                                    // Link tr·ª±c ti·∫øp t·ªõi file trong wwwroot (FilePath n√™n l√† /uploads/filename)
                                    <a href="@sub.FilePath" download>T·∫£i</a>
                                }
                                else
                                {
                                    <text>-</text>
                                }
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script>
        // Initialize CKEditor for description
        var descriptionEditor = CKEDITOR.replace('descriptionEditor', {
            filebrowserBrowseUrl: '/ckfinder/ckfinder/ckfinder.html',
            filebrowserImageBrowseUrl: '/ckfinder/ckfinder/ckfinder.html?type=Images',
            filebrowserUploadUrl: '/ckfinder/ckfinder/core/connector/aspx/connector.aspx?command=QuickUpload&type=Files',
            filebrowserImageUploadUrl: '/ckfinder/ckfinder/core/connector/aspx/connector.aspx?command=QuickUpload&type=Images',
            height: 300
        });

        // Update textarea before form submit
        document.getElementById('editAssignmentForm')?.addEventListener('submit', function(e) {
            for (var instance in CKEDITOR.instances) {
                CKEDITOR.instances[instance].updateElement();
            }
        });
    </script>
}
