@model CourseManagement.Models.ClassRoom

<h1>Chỉnh sửa lớp: @Model.Title</h1>

@* Hiển thị thông báo từ TempData *@
@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (!string.IsNullOrEmpty(Model.EnrollmentPasswordHash))
{
    <div class="alert alert-info">Lớp hiện có mật khẩu ghi danh đặt sẵn.</div>
}

<form method="post" class="row g-2">
    @Html.AntiForgeryToken()
    <div class="col-md-8">
        <label class="form-label">Mật khẩu ghi danh (để trống để xoá)</label>
        <input name="enrollmentPassword" class="form-control" />
    </div>
    <div class="col-md-4 align-self-end">
        <button type="submit" class="btn btn-primary">Lưu</button>
    </div>
</form>

<hr />
<h3>Nội dung lớp</h3>
<!-- Simple editor: choose Text or Assignment -->
<div class="mb-3">
    <label class="form-label">Thêm nội dung</label>
    <div>
        <a class="btn btn-outline-secondary me-2" href="#"
            onclick="document.getElementById('textArea').style.display='block'; document.getElementById('assignmentForm').style.display='none'; return false;">Text</a>
        <a class="btn btn-outline-secondary" href="#"
            onclick="document.getElementById('assignmentForm').style.display='block'; document.getElementById('textArea').style.display='none'; return false;">Bài
            tập</a>
    </div>
</div>

<!-- Text editor area (simple textarea for now) -->
<div id="textArea" style="display:none;">
    <label class="form-label">Nội dung (Text)</label>
    <textarea id="contentEditor" class="form-control" rows="6"></textarea>
    <div class="mt-2">
        <button class="btn btn-primary ms-3" onclick="saveContentFromEditor(@Model.Id)">Lưu nội dung</button>
    </div>
</div>

<!-- Create assignment quick form -->
<div id="assignmentForm" style="display:none;">
    <form asp-controller="Assignments" asp-action="CreateFromEditor" method="post">
        @Html.AntiForgeryToken()
        <input type="hidden" name="classId" value="@Model.Id" />
        <div class="mb-2">
            <label class="form-label">Tiêu đề bài tập</label>
            <input name="title" class="form-control" />
        </div>
        <div class="mb-2">
            <label class="form-label">Mô tả ngắn (tuỳ chọn)</label>
            <textarea id="assignmentDescEditor" name="description" class="form-control" rows="3"></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Tạo bài tập</button>
    </form>
</div>

<div class="mt-4" id="contentBlocksArea">
    @* Anti-forgery token for AJAX posts *@
    @Html.AntiForgeryToken()
    @{
        var db = Context.RequestServices.GetService(typeof(CourseManagement.Data.ApplicationDbContext)) as
        CourseManagement.Data.ApplicationDbContext;
    }
    @if (db != null)
    {
        // Render assignment blocks first so they appear in the content flow and persist after reload
        var assigns = db.Assignments.Where(a => a.ClassRoomId == Model.Id).OrderBy(a => a.CreatedAt).ToList();
        foreach (var a in assigns)
        {
            <partial name="_AssignmentBlock" model="a" />
        }

        var list = db.ContentBlocks.Where(cb => cb.ClassRoomId == Model.Id).OrderBy(cb => cb.Order).ToList();
        foreach (var b in list)
        {
            <partial name="_ContentBlock" model="b" />
        }
    }
    <div id="addBlockPicker" class="p-3 border rounded mt-3"
        onmouseover="this.querySelector('.picker').style.display='block'"
        onmouseout="this.querySelector('.picker').style.display='none'">
        <div class="picker" style="display:none;">
            <button class="btn btn-outline-secondary me-2"
                onclick="showNewTextBlock(@Model.Id); return false;">Text</button>
            <button class="btn btn-outline-secondary" onclick="showNewAssignment(@Model.Id); return false;">Bài
                tập</button>
        </div>
        <div id="newBlockArea"></div>
    </div>
</div>

<script>
    var newTextEditor;
    var newAssignDescEditor;

    function showNewTextBlock(classId) {
        var area = document.getElementById('newBlockArea');
        area.innerHTML = '<textarea id="newText" class="form-control" rows="4"></textarea><div class="mt-2"><button class="btn btn-primary" onclick="createBlock(' + classId + ')">Lưu</button></div>';

        // Initialize CKEditor for new text block
        setTimeout(function () {
            if (newTextEditor) {
                newTextEditor.destroy();
            }
            newTextEditor = CKEDITOR.replace('newText', {
                filebrowserBrowseUrl: '/ckfinder/ckfinder/ckfinder.html',
                filebrowserImageBrowseUrl: '/ckfinder/ckfinder/ckfinder.html?type=Images',
                filebrowserUploadUrl: '/ckfinder/ckfinder/core/connector/aspx/connector.aspx?command=QuickUpload&type=Files',
                filebrowserImageUploadUrl: '/ckfinder/ckfinder/core/connector/aspx/connector.aspx?command=QuickUpload&type=Images',
                height: 200
            });
        }, 100);
    }
    function showNewAssignment(classId) {
        var area = document.getElementById('newBlockArea');
        area.innerHTML = '\n            <div class="p-3 border rounded mb-3">\n                <div class="mb-2">\n                    <label class="form-label">Tiêu đề bài tập</label>\n                    <input id="newAssignTitle" class="form-control" />\n                </div>\n                <div class="mb-2">\n                    <label class="form-label">Mô tả ngắn (tuỳ chọn)</label>\n                    <textarea id="newAssignDesc" class="form-control" rows="2"></textarea>\n                </div>\n                <div class="text-end">\n                    <button class="btn btn-sm btn-secondary" onclick="cancelNewAssign()">Huỷ</button>\n                    <button class="btn btn-sm btn-primary" onclick="createAssignment(' + classId + ')">Tạo</button>\n                </div>\n            </div>';

        // Initialize CKEditor for new assignment description
        setTimeout(function () {
            if (newAssignDescEditor) {
                newAssignDescEditor.destroy();
            }
            newAssignDescEditor = CKEDITOR.replace('newAssignDesc', {
                filebrowserBrowseUrl: '/ckfinder/ckfinder/ckfinder.html',
                filebrowserImageBrowseUrl: '/ckfinder/ckfinder/ckfinder.html?type=Images',
                filebrowserUploadUrl: '/ckfinder/ckfinder/core/connector/aspx/connector.aspx?command=QuickUpload&type=Files',
                filebrowserImageUploadUrl: '/ckfinder/ckfinder/core/connector/aspx/connector.aspx?command=QuickUpload&type=Images',
                height: 150
            });
        }, 100);
    }

    function cancelNewAssign() {
        if (newAssignDescEditor) {
            newAssignDescEditor.destroy();
            newAssignDescEditor = null;
        }
        document.getElementById('newBlockArea').innerHTML = '';
    }

    async function createAssignment(classId) {
        var title = document.getElementById('newAssignTitle')?.value;
        var desc = newAssignDescEditor ? newAssignDescEditor.getData() : '';
        if (!title || title.trim().length == 0) { alert('Vui lòng nhập tiêu đề'); return; }
        var form = new FormData();
        var token = document.querySelector('input[name=__RequestVerificationToken]')?.value;
        if (token) form.append('__RequestVerificationToken', token);
        form.append('classId', classId);
        form.append('title', title);
        form.append('description', desc || '');

        var res = await fetch('/Assignments/CreateFromEditor', { method: 'POST', body: form, headers: { 'X-Requested-With': 'XMLHttpRequest' } });
        if (res.ok) {
            var html = await res.text();
            // insert before the add picker (so new items appear above the picker)
            var picker = document.getElementById('addBlockPicker');
            picker.insertAdjacentHTML('beforebegin', html);
            if (newAssignDescEditor) {
                newAssignDescEditor.destroy();
                newAssignDescEditor = null;
            }
            document.getElementById('newBlockArea').innerHTML = '';
        } else {
            var txt = await res.text();
            alert('Tạo bài tập thất bại: ' + res.status + '\n' + txt);
        }
    }
    async function createBlock(classId) {
        if (!newTextEditor) return;
        var content = newTextEditor.getData();
        if (!content || content.trim().length == 0) {
            alert('Vui lòng nhập nội dung');
            return;
        }
        var form = new FormData();
        form.append('__RequestVerificationToken', document.querySelector('input[name=__RequestVerificationToken]').value);
        form.append('classId', classId);
        form.append('content', content);
        var res = await fetch('/ContentBlocks/Create', { method: 'POST', body: form });
        if (res.ok) {
            var html = await res.text();
            document.getElementById('contentBlocksArea').insertAdjacentHTML('beforeend', html);
            if (newTextEditor) {
                newTextEditor.destroy();
                newTextEditor = null;
            }
            document.getElementById('newBlockArea').innerHTML = '';
        } else alert('Tạo thất bại');
    }
</script>

<script>
    // Delegated handlers for content-block interactions
    document.addEventListener('click', function (e) {
        var del = e.target.closest('button[data-action="delete"]');
        if (del) {
            var id = del.getAttribute('data-id');
            deleteBlock(id);
            return;
        }
        var saveBtn = e.target.closest('button[data-action="save"]');
        if (saveBtn) {
            // handled by save logic below via event delegation
            return;
        }
        var cancelBtn = e.target.closest('button[data-action="cancel"]');
        if (cancelBtn) {
            var block = cancelBtn.closest('.content-block');
            if (editBlockEditor) {
                editBlockEditor.destroy();
                editBlockEditor = null;
            }
            var ta = block.querySelector('textarea');
            if (ta) ta.remove();
            var display = block.querySelector('[data-editable]');
            var controls = block.querySelector('[data-controls]');
            if (display) display.style.display = 'block';
            if (controls) controls.style.display = 'none';
            return;
        }
    });

    document.addEventListener('dblclick', function (e) {
        var ed = e.target.closest('[data-editable]');
        if (ed) { enableEdit(ed); }
    });

    var editBlockEditor;

    function enableEdit(el) {
        var block = el.closest('.content-block');
        if (!block) return;
        var id = block.getAttribute('data-block-id');
        var content = el.innerHTML;
        var ta = document.createElement('textarea');
        ta.className = 'form-control';
        ta.id = 'editBlockTextarea_' + id;
        ta.style.minHeight = '120px';
        ta.value = content.replace(/<br\s*\/?\s*>/g, '\n');
        el.style.display = 'none';
        var controls = block.querySelector('[data-controls]');
        if (controls) controls.style.display = 'block';
        if (controls) controls.innerHTML = '<button class="btn btn-sm btn-primary" data-action="save" data-id="' + id + '">Lưu</button> <button class="btn btn-sm btn-secondary" data-action="cancel">Huỷ</button>';
        block.insertBefore(ta, controls);

        // Initialize CKEditor for editing
        setTimeout(function () {
            if (editBlockEditor) {
                editBlockEditor.destroy();
            }
            editBlockEditor = CKEDITOR.replace('editBlockTextarea_' + id, {
                filebrowserBrowseUrl: '/ckfinder/ckfinder/ckfinder.html',
                filebrowserImageBrowseUrl: '/ckfinder/ckfinder/ckfinder.html?type=Images',
                filebrowserUploadUrl: '/ckfinder/ckfinder/core/connector/aspx/connector.aspx?command=QuickUpload&type=Files',
                filebrowserImageUploadUrl: '/ckfinder/ckfinder/core/connector/aspx/connector.aspx?command=QuickUpload&type=Images',
                height: 200
            });
            editBlockEditor.setData(content);
        }, 100);
    }

    document.addEventListener('click', async function (e) {
        var save = e.target.closest('button[data-action="save"]');
        if (!save) return;
        var id = save.getAttribute('data-id');
        var block = save.closest('.content-block');

        var content;
        if (editBlockEditor) {
            content = editBlockEditor.getData();
        } else {
            var ta = block.querySelector('textarea');
            if (!ta) return;
            content = ta.value;
        }

        var form = new FormData();
        var tokenInput = document.querySelector('input[name=__RequestVerificationToken]');
        if (tokenInput) form.append('__RequestVerificationToken', tokenInput.value);
        form.append('id', id);
        form.append('content', content);
        var res = await fetch('/ContentBlocks/Update', { method: 'POST', body: form });
        if (res.ok) {
            if (editBlockEditor) {
                editBlockEditor.destroy();
                editBlockEditor = null;
            }
            var html = await res.text();
            block.outerHTML = html;
        } else {
            alert('Lưu thất bại');
        }
    });

    async function deleteBlock(id) {
        if (!confirm('Xác nhận xóa?')) return;
        var form = new FormData();
        var tokenInput = document.querySelector('input[name=__RequestVerificationToken]');
        if (tokenInput) form.append('__RequestVerificationToken', tokenInput.value);
        form.append('id', id);
        var res = await fetch('/ContentBlocks/Delete', { method: 'POST', body: form });
        if (res.ok) {
            document.querySelector('.content-block[data-block-id="' + id + '"]')?.remove();
        } else alert('Xóa thất bại');
    }

    // CKEditor initialization
    var contentEditor;
    var assignmentDescEditor;

    // Initialize CKEditor when text area is shown
    document.querySelector('a[onclick*="textArea"]').addEventListener('click', function () {
        setTimeout(function () {
            if (!contentEditor) {
                contentEditor = CKEDITOR.replace('contentEditor', {
                    filebrowserBrowseUrl: '/ckfinder/ckfinder/ckfinder.html',
                    filebrowserImageBrowseUrl: '/ckfinder/ckfinder/ckfinder.html?type=Images',
                    filebrowserUploadUrl: '/ckfinder/ckfinder/core/connector/aspx/connector.aspx?command=QuickUpload&type=Files',
                    filebrowserImageUploadUrl: '/ckfinder/ckfinder/core/connector/aspx/connector.aspx?command=QuickUpload&type=Images',
                    height: 300
                });
            }
        }, 100);
    });

    // Initialize CKEditor for assignment description
    document.querySelector('a[onclick*="assignmentForm"]').addEventListener('click', function () {
        setTimeout(function () {
            if (!assignmentDescEditor) {
                assignmentDescEditor = CKEDITOR.replace('assignmentDescEditor', {
                    filebrowserBrowseUrl: '/ckfinder/ckfinder/ckfinder.html',
                    filebrowserImageBrowseUrl: '/ckfinder/ckfinder/ckfinder.html?type=Images',
                    filebrowserUploadUrl: '/ckfinder/ckfinder/core/connector/aspx/connector.aspx?command=QuickUpload&type=Files',
                    filebrowserImageUploadUrl: '/ckfinder/ckfinder/core/connector/aspx/connector.aspx?command=QuickUpload&type=Images',
                    height: 200
                });
            }
        }, 100);
    });

    // Save content from CKEditor
    async function saveContentFromEditor(classId) {
        if (!contentEditor) return;
        var content = contentEditor.getData();
        if (!content || content.trim().length == 0) {
            alert('Vui lòng nhập nội dung');
            return;
        }

        var form = new FormData();
        form.append('__RequestVerificationToken', document.querySelector('input[name=__RequestVerificationToken]').value);
        form.append('classId', classId);
        form.append('content', content);

        var res = await fetch('/ContentBlocks/Create', { method: 'POST', body: form });
        if (res.ok) {
            var html = await res.text();
            document.getElementById('contentBlocksArea').insertAdjacentHTML('beforeend', html);
            contentEditor.setData('');
            document.getElementById('textArea').style.display = 'none';
        } else {
            alert('Tạo thất bại');
        }
    }
</script>