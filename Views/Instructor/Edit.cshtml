@model CourseManagement.Models.ClassRoom

@{
    Layout = "~/Views/Shared/_InstructorLayout.cshtml";
    ViewData["Title"] = "Quản lý khóa học - " + Model.Title;
}

<!-- Page Header -->
<div class="dashboard-card">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="mb-0">
            <i class="bi bi-book me-2"></i>@Model.Title
        </h1>
        <a asp-action="Index" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>Quay lại danh sách
        </a>
    </div>

    @* Hiển thị thông báo từ TempData *@
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i>@TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>@TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(Model.EnrollmentPasswordHash))
    {
        <div class="alert alert-info">
            <i class="bi bi-shield-lock-fill me-2"></i>Lớp hiện có mật khẩu ghi danh đặt sẵn.
        </div>
    }

    <!-- Enrollment Password Form -->
    <div class="card border-0 bg-light">
        <div class="card-body">
            <h5 class="card-title">
                <i class="bi bi-key-fill me-2"></i>Mật khẩu ghi danh
            </h5>
            <form method="post" class="row g-3">
                @Html.AntiForgeryToken()
                <div class="col-md-8">
                    <label class="form-label">Mật khẩu ghi danh (để trống để xoá)</label>
                    <input name="enrollmentPassword" class="form-control"
                        placeholder="Nhập mật khẩu mới hoặc để trống để xóa" />
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-save me-1"></i>Lưu
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Course Content Section -->
<div class="dashboard-card">
    <h3><i class="bi bi-layers-fill me-2"></i>Nội dung lớp học</h3>

    <!-- Add Content Section -->
    <div class="add-content-section">
        <label class="form-label">Thêm nội dung mới</label>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary"
                onclick="document.getElementById('textArea').style.display='block'; document.getElementById('assignmentForm').style.display='none';">
                <i class="bi bi-file-text me-1"></i>Text
            </button>
            <button type="button" class="btn btn-outline-primary"
                onclick="document.getElementById('assignmentForm').style.display='block'; document.getElementById('textArea').style.display='none';">
                <i class="bi bi-clipboard-check me-1"></i>Bài tập
            </button>
        </div>
    </div>

    <!-- Text editor area (simple textarea for now) -->
    <div id="textArea" style="display:none;" class="card border-primary mt-3">
        <div class="card-header bg-primary text-white">
            <i class="bi bi-file-text me-2"></i>Thêm nội dung văn bản
        </div>
        <div class="card-body">
            <label class="form-label">Nội dung</label>
            <textarea id="contentEditor" class="form-control" rows="6"></textarea>
            <div class="mt-3 text-end">
                <button class="btn btn-secondary me-2"
                    onclick="document.getElementById('textArea').style.display='none'">
                    <i class="bi bi-x-lg me-1"></i>Hủy
                </button>
                <button class="btn btn-primary" onclick="saveContentFromEditor(@Model.Id)">
                    <i class="bi bi-save me-1"></i>Lưu nội dung
                </button>
            </div>
        </div>
    </div>

    <!-- Create assignment quick form -->
    <div id="assignmentForm" style="display:none;" class="card border-success mt-3">
        <div class="card-header bg-success text-white">
            <i class="bi bi-clipboard-check me-2"></i>Tạo bài tập mới
        </div>
        <div class="card-body">
            <form asp-controller="Assignments" asp-action="CreateFromEditor" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="classId" value="@Model.Id" />
                <div class="mb-3">
                    <label class="form-label">Tiêu đề bài tập</label>
                    <input name="title" class="form-control" placeholder="Nhập tiêu đề bài tập" required />
                </div>
                <div class="mb-3">
                    <label class="form-label">Mô tả ngắn (tuỳ chọn)</label>
                    <textarea id="assignmentDescEditor" name="description" class="form-control" rows="3"
                        placeholder="Nhập mô tả cho bài tập"></textarea>
                </div>
                <div class="text-end">
                    <button type="button" class="btn btn-secondary me-2"
                        onclick="document.getElementById('assignmentForm').style.display='none'">
                        <i class="bi bi-x-lg me-1"></i>Hủy
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-plus-circle me-1"></i>Tạo bài tập
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Content Blocks List -->
    <div class="mt-4" id="contentBlocksArea">
        @* Anti-forgery token for AJAX posts *@
        @Html.AntiForgeryToken()
        @{
            var db = Context.RequestServices.GetService(typeof(CourseManagement.Data.ApplicationDbContext)) as
            CourseManagement.Data.ApplicationDbContext;
        }
        @if (db != null)
        {
            // Render assignment blocks first so they appear in the content flow and persist after reload
            var assigns = db.Assignments.Where(a => a.ClassRoomId == Model.Id).OrderBy(a => a.CreatedAt).ToList();
            var contentBlocks = db.ContentBlocks.Where(cb => cb.ClassRoomId == Model.Id).OrderBy(cb => cb.Order).ToList();

            if (assigns.Any() || contentBlocks.Any())
            {
                <h5 class="mb-3"><i class="bi bi-list-ul me-2"></i>Danh sách nội dung</h5>
            }

            foreach (var a in assigns)
            {
                <partial name="_AssignmentBlock" model="a" />
            }

            foreach (var b in contentBlocks)
            {
                <partial name="_ContentBlock" model="b" />
            }
        }
        <div id="addBlockPicker" class="p-3 border rounded mt-3 text-center add-content-section"
            onmouseover="this.querySelector('.picker').style.display='block'"
            onmouseout="this.querySelector('.picker').style.display='none'">
            <div class="picker" style="display:none;">
                <button class="btn btn-outline-primary me-2" onclick="showNewTextBlock(@Model.Id); return false;">
                    <i class="bi bi-file-text me-1"></i>Text
                </button>
                <button class="btn btn-outline-success" onclick="showNewAssignment(@Model.Id); return false;">
                    <i class="bi bi-clipboard-check me-1"></i>Bài tập
                </button>
            </div>
            <div id="newBlockArea"></div>
        </div>
    </div>
</div>

<script>
    var newTextEditor;
    var newAssignDescEditor;

    function showNewTextBlock(classId) {
        var area = document.getElementById('newBlockArea');
        area.innerHTML = '<textarea id="newText" class="form-control" rows="4"></textarea><div class="mt-2"><button class="btn btn-primary" onclick="createBlock(' + classId + ')">Lưu</button></div>';

        // Initialize CKEditor for new text block
        setTimeout(function () {
            if (newTextEditor) {
                newTextEditor.destroy();
            }
            newTextEditor = CKEDITOR.replace('newText', {
                filebrowserBrowseUrl: '/ckfinder/ckfinder/ckfinder.html',
                filebrowserImageBrowseUrl: '/ckfinder/ckfinder/ckfinder.html?type=Images',
                filebrowserUploadUrl: '/ckfinder/ckfinder/core/connector/aspx/connector.aspx?command=QuickUpload&type=Files',
                filebrowserImageUploadUrl: '/ckfinder/ckfinder/core/connector/aspx/connector.aspx?command=QuickUpload&type=Images',
                height: 200
            });
        }, 100);
    }
    function showNewAssignment(classId) {
        var area = document.getElementById('newBlockArea');
        area.innerHTML = '\n            <div class="p-3 border rounded mb-3">\n                <div class="mb-2">\n                    <label class="form-label">Tiêu đề bài tập</label>\n                    <input id="newAssignTitle" class="form-control" />\n                </div>\n                <div class="mb-2">\n                    <label class="form-label">Mô tả ngắn (tuỳ chọn)</label>\n                    <textarea id="newAssignDesc" class="form-control" rows="2"></textarea>\n                </div>\n                <div class="text-end">\n                    <button class="btn btn-sm btn-secondary" onclick="cancelNewAssign()">Huỷ</button>\n                    <button class="btn btn-sm btn-primary" onclick="createAssignment(' + classId + ')">Tạo</button>\n                </div>\n            </div>';

        // Initialize CKEditor for new assignment description
        setTimeout(function () {
            if (newAssignDescEditor) {
                newAssignDescEditor.destroy();
            }
            newAssignDescEditor = CKEDITOR.replace('newAssignDesc', {
                filebrowserBrowseUrl: '/ckfinder/ckfinder/ckfinder.html',
                filebrowserImageBrowseUrl: '/ckfinder/ckfinder/ckfinder.html?type=Images',
                filebrowserUploadUrl: '/ckfinder/ckfinder/core/connector/aspx/connector.aspx?command=QuickUpload&type=Files',
                filebrowserImageUploadUrl: '/ckfinder/ckfinder/core/connector/aspx/connector.aspx?command=QuickUpload&type=Images',
                height: 150
            });
        }, 100);
    }

    function cancelNewAssign() {
        if (newAssignDescEditor) {
            newAssignDescEditor.destroy();
            newAssignDescEditor = null;
        }
        document.getElementById('newBlockArea').innerHTML = '';
    }

    async function createAssignment(classId) {
        var title = document.getElementById('newAssignTitle')?.value;
        var desc = newAssignDescEditor ? newAssignDescEditor.getData() : '';
        if (!title || title.trim().length == 0) { alert('Vui lòng nhập tiêu đề'); return; }
        var form = new FormData();
        var token = document.querySelector('input[name=__RequestVerificationToken]')?.value;
        if (token) form.append('__RequestVerificationToken', token);
        form.append('classId', classId);
        form.append('title', title);
        form.append('description', desc || '');

        var res = await fetch('/Assignments/CreateFromEditor', { method: 'POST', body: form, headers: { 'X-Requested-With': 'XMLHttpRequest' } });
        if (res.ok) {
            var html = await res.text();
            // insert before the add picker (so new items appear above the picker)
            var picker = document.getElementById('addBlockPicker');
            picker.insertAdjacentHTML('beforebegin', html);
            if (newAssignDescEditor) {
                newAssignDescEditor.destroy();
                newAssignDescEditor = null;
            }
            document.getElementById('newBlockArea').innerHTML = '';
        } else {
            var txt = await res.text();
            alert('Tạo bài tập thất bại: ' + res.status + '\n' + txt);
        }
    }
    async function createBlock(classId) {
        if (!newTextEditor) return;
        var content = newTextEditor.getData();
        if (!content || content.trim().length == 0) {
            alert('Vui lòng nhập nội dung');
            return;
        }
        var form = new FormData();
        form.append('__RequestVerificationToken', document.querySelector('input[name=__RequestVerificationToken]').value);
        form.append('classId', classId);
        form.append('content', content);
        var res = await fetch('/ContentBlocks/Create', { method: 'POST', body: form });
        if (res.ok) {
            var html = await res.text();
            document.getElementById('contentBlocksArea').insertAdjacentHTML('beforeend', html);
            if (newTextEditor) {
                newTextEditor.destroy();
                newTextEditor = null;
            }
            document.getElementById('newBlockArea').innerHTML = '';
        } else alert('Tạo thất bại');
    }
</script>

<script>
    // Delegated handlers for content-block interactions
    document.addEventListener('click', function (e) {
        var del = e.target.closest('button[data-action="delete"]');
        if (del) {
            var id = del.getAttribute('data-id');
            deleteBlock(id);
            return;
        }
        var saveBtn = e.target.closest('button[data-action="save"]');
        if (saveBtn) {
            // handled by save logic below via event delegation
            return;
        }
        var cancelBtn = e.target.closest('button[data-action="cancel"]');
        if (cancelBtn) {
            var block = cancelBtn.closest('.content-block');
            if (editBlockEditor) {
                editBlockEditor.destroy();
                editBlockEditor = null;
            }
            var ta = block.querySelector('textarea');
            if (ta) ta.remove();
            var display = block.querySelector('[data-editable]');
            var controls = block.querySelector('[data-controls]');
            if (display) display.style.display = 'block';
            if (controls) controls.style.display = 'none';
            return;
        }
    });

    document.addEventListener('dblclick', function (e) {
        var ed = e.target.closest('[data-editable]');
        if (ed) { enableEdit(ed); }
    });

    var editBlockEditor;

    function enableEdit(el) {
        var block = el.closest('.content-block');
        if (!block) return;
        var id = block.getAttribute('data-block-id');
        var content = el.innerHTML;
        var ta = document.createElement('textarea');
        ta.className = 'form-control';
        ta.id = 'editBlockTextarea_' + id;
        ta.style.minHeight = '120px';
        ta.value = content.replace(/<br\s*\/?\s*>/g, '\n');
        el.style.display = 'none';
        var controls = block.querySelector('[data-controls]');
        if (controls) controls.style.display = 'block';
        if (controls) controls.innerHTML = '<button class="btn btn-sm btn-primary" data-action="save" data-id="' + id + '">Lưu</button> <button class="btn btn-sm btn-secondary" data-action="cancel">Huỷ</button>';
        block.insertBefore(ta, controls);

        // Initialize CKEditor for editing
        setTimeout(function () {
            if (editBlockEditor) {
                editBlockEditor.destroy();
            }
            editBlockEditor = CKEDITOR.replace('editBlockTextarea_' + id, {
                filebrowserBrowseUrl: '/ckfinder/ckfinder/ckfinder.html',
                filebrowserImageBrowseUrl: '/ckfinder/ckfinder/ckfinder.html?type=Images',
                filebrowserUploadUrl: '/ckfinder/ckfinder/core/connector/aspx/connector.aspx?command=QuickUpload&type=Files',
                filebrowserImageUploadUrl: '/ckfinder/ckfinder/core/connector/aspx/connector.aspx?command=QuickUpload&type=Images',
                height: 200
            });
            editBlockEditor.setData(content);
        }, 100);
    }

    document.addEventListener('click', async function (e) {
        var save = e.target.closest('button[data-action="save"]');
        if (!save) return;
        var id = save.getAttribute('data-id');
        var block = save.closest('.content-block');

        var content;
        if (editBlockEditor) {
            content = editBlockEditor.getData();
        } else {
            var ta = block.querySelector('textarea');
            if (!ta) return;
            content = ta.value;
        }

        var form = new FormData();
        var tokenInput = document.querySelector('input[name=__RequestVerificationToken]');
        if (tokenInput) form.append('__RequestVerificationToken', tokenInput.value);
        form.append('id', id);
        form.append('content', content);
        var res = await fetch('/ContentBlocks/Update', { method: 'POST', body: form });
        if (res.ok) {
            if (editBlockEditor) {
                editBlockEditor.destroy();
                editBlockEditor = null;
            }
            var html = await res.text();
            block.outerHTML = html;
        } else {
            alert('Lưu thất bại');
        }
    });

    async function deleteBlock(id) {
        if (!confirm('Xác nhận xóa?')) return;
        var form = new FormData();
        var tokenInput = document.querySelector('input[name=__RequestVerificationToken]');
        if (tokenInput) form.append('__RequestVerificationToken', tokenInput.value);
        form.append('id', id);
        var res = await fetch('/ContentBlocks/Delete', { method: 'POST', body: form });
        if (res.ok) {
            document.querySelector('.content-block[data-block-id="' + id + '"]')?.remove();
        } else alert('Xóa thất bại');
    }

    // CKEditor initialization
    var contentEditor;
    var assignmentDescEditor;

    // Initialize CKEditor when document is ready
    document.addEventListener('DOMContentLoaded', function () {
        // Event handler for Text button
        var textButtons = document.querySelectorAll('button[onclick*="textArea"]');
        textButtons.forEach(function(btn) {
            btn.addEventListener('click', function () {
                setTimeout(function () {
                    if (!contentEditor) {
                        contentEditor = CKEDITOR.replace('contentEditor', {
                            filebrowserBrowseUrl: '/ckfinder/ckfinder/ckfinder.html',
                            filebrowserImageBrowseUrl: '/ckfinder/ckfinder/ckfinder.html?type=Images',
                            filebrowserUploadUrl: '/ckfinder/ckfinder/core/connector/aspx/connector.aspx?command=QuickUpload&type=Files',
                            filebrowserImageUploadUrl: '/ckfinder/ckfinder/core/connector/aspx/connector.aspx?command=QuickUpload&type=Images',
                            height: 300
                        });
                    }
                }, 200);
            });
        });

        // Event handler for Assignment button
        var assignmentButtons = document.querySelectorAll('button[onclick*="assignmentForm"]');
        assignmentButtons.forEach(function(btn) {
            btn.addEventListener('click', function () {
                setTimeout(function () {
                    if (!assignmentDescEditor) {
                        assignmentDescEditor = CKEDITOR.replace('assignmentDescEditor', {
                            filebrowserBrowseUrl: '/ckfinder/ckfinder/ckfinder.html',
                            filebrowserImageBrowseUrl: '/ckfinder/ckfinder/ckfinder.html?type=Images',
                            filebrowserUploadUrl: '/ckfinder/ckfinder/core/connector/aspx/connector.aspx?command=QuickUpload&type=Files',
                            filebrowserImageUploadUrl: '/ckfinder/ckfinder/core/connector/aspx/connector.aspx?command=QuickUpload&type=Images',
                            height: 200
                        });
                    }
                }, 200);
            });
        });
    });

    // Save content from CKEditor
    async function saveContentFromEditor(classId) {
        if (!contentEditor) return;
        var content = contentEditor.getData();
        if (!content || content.trim().length == 0) {
            alert('Vui lòng nhập nội dung');
            return;
        }

        var form = new FormData();
        form.append('__RequestVerificationToken', document.querySelector('input[name=__RequestVerificationToken]').value);
        form.append('classId', classId);
        form.append('content', content);

        var res = await fetch('/ContentBlocks/Create', { method: 'POST', body: form });
        if (res.ok) {
            var html = await res.text();
            document.getElementById('contentBlocksArea').insertAdjacentHTML('beforeend', html);
            contentEditor.setData('');
            document.getElementById('textArea').style.display = 'none';
        } else {
            alert('Tạo thất bại');
        }
    }
</script>